WALLY_CONTAINER_BASE_IMAGE ?= docker.io/almalinux/9-base:9.6
WALLY_CONTAINER_IMAGE_REGISTRY ?= localhost
WALLY_CONTAINER_IMAGE_REGISTRY_REMOTE ?= ghcr.io/openhwgroup
WALLY_CONTAINER_IMAGE_NAME ?= wally
WALLY_CONTAINER_TARGET_VERSION ?= latest
WALLY_CONTAINER_CURRENT_VERSION ?= $(shell date +'%Y%m%d')

WALLY_CONTAINER_BUILD_CONTEXT ?= .. # Set to the project root

info:
	@echo "Container version: ${WALLY_CONTAINER_TARGET_VERSION}"
	@echo "Container current version: ${WALLY_CONTAINER_CURRENT_VERSION}"

builder:
	buildah build \
		-f wally-devel/Dockerfile \
		--build-arg WALLY_CONTAINER_BASE_IMAGE=${WALLY_CONTAINER_BASE_IMAGE} \
		--build-arg WALLY_CONTAINER_VERSION=${WALLY_CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target wally-builder \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_TARGET_VERSION}-builder \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_CURRENT_VERSION}-builder \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY_REMOTE}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_TARGET_VERSION}-builder \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY_REMOTE}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_CURRENT_VERSION}-builder \
	${WALLY_CONTAINER_BUILD_CONTEXT}

devel: builder
	buildah build \
		-f wally-devel/Dockerfile \
		--build-arg WALLY_CONTAINER_BASE_IMAGE=${WALLY_CONTAINER_BASE_IMAGE} \
		--build-arg WALLY_CONTAINER_VERSION=${WALLY_CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target wally-devel \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_TARGET_VERSION}-devel \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_CURRENT_VERSION}-devel \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY_REMOTE}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_TARGET_VERSION}-devel \
		--tag ${WALLY_CONTAINER_IMAGE_REGISTRY_REMOTE}/${WALLY_CONTAINER_IMAGE_NAME}:${WALLY_CONTAINER_CURRENT_VERSION}-devel \
	${WALLY_CONTAINER_BUILD_CONTEXT}
