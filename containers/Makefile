CONTAINER_IMAGE_REGISTRY ?= localhost
CONTAINER_IMAGE_REGISTRY_REMOTE ?= ghcr.io/openhwgroup
CONTAINER_IMAGE_NAME ?= wally
CONTAINER_TARGET_VERSION ?= latest
CONTAINER_CURRENT_VERSION ?= $(shell date +'%Y%m%d')

CONTAINER_BUILD_CONTEXT ?= .. # Fix if installation scripts are in a different location

info:
	@echo "Container version: ${CONTAINER_TARGET_VERSION}"
	@echo "Container current version: ${CONTAINER_CURRENT_VERSION}"

builder:
	buildah build \
		-f wally-devel/Dockerfile \
		--build-arg CONTAINER_IMAGE_REGISTRY=${CONTAINER_IMAGE_REGISTRY} \
		--build-arg CONTAINER_IMAGE_REGISTRY_REMOTE=${CONTAINER_IMAGE_REGISTRY_REMOTE} \
		--build-arg CONTAINER_IMAGE_NAME=${CONTAINER_IMAGE_NAME} \
		--build-arg CONTAINER_VERSION=${CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target wally-builder \
		--tag ${CONTAINER_IMAGE_REGISTRY}/${CONTAINER_IMAGE_NAME}:${CONTAINER_TARGET_VERSION}-builder \
		--tag ${CONTAINER_IMAGE_REGISTRY}/${CONTAINER_IMAGE_NAME}:${CONTAINER_CURRENT_VERSION}-builder \
		--tag ${CONTAINER_IMAGE_REGISTRY_REMOTE}/${CONTAINER_IMAGE_NAME}:${CONTAINER_TARGET_VERSION}-builder \
		--tag ${CONTAINER_IMAGE_REGISTRY_REMOTE}/${CONTAINER_IMAGE_NAME}:${CONTAINER_CURRENT_VERSION}-builder \
	${CONTAINER_BUILD_CONTEXT}

devel: builder
	buildah build \
		-f wally-devel/Dockerfile \
		--build-arg CONTAINER_IMAGE_REGISTRY=${CONTAINER_IMAGE_REGISTRY} \
		--build-arg CONTAINER_IMAGE_REGISTRY_REMOTE=${CONTAINER_IMAGE_REGISTRY_REMOTE} \
		--build-arg CONTAINER_IMAGE_NAME=${CONTAINER_IMAGE_NAME} \
		--build-arg CONTAINER_VERSION=${CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target wally-devel \
		--tag ${CONTAINER_IMAGE_REGISTRY}/${CONTAINER_IMAGE_NAME}:${CONTAINER_TARGET_VERSION}-devel \
		--tag ${CONTAINER_IMAGE_REGISTRY}/${CONTAINER_IMAGE_NAME}:${CONTAINER_CURRENT_VERSION}-devel \
		--tag ${CONTAINER_IMAGE_REGISTRY_REMOTE}/${CONTAINER_IMAGE_NAME}:${CONTAINER_TARGET_VERSION}-devel \
		--tag ${CONTAINER_IMAGE_REGISTRY_REMOTE}/${CONTAINER_IMAGE_NAME}:${CONTAINER_CURRENT_VERSION}-devel \
	${CONTAINER_BUILD_CONTEXT}
