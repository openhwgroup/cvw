# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **competitive RISC-V processor design exercise** within the CORE-V Wally (CVW) repository. Students implement custom RISC-V processors in SystemVerilog, validate them against the RISC-V architecture test suite, benchmark with CoreMark, synthesize with Synopsys Design Compiler, and compete for the lowest composite score.

**Scoring formula:** `Score = 1 / ((MTIME × Critical_Path_Length)^3 * Area)` — lower is better. This heavily penalizes slow designs (cubed execution time) while rewarding small area.

## Environment Setup

```bash
# Required every session — sets $WALLY, $RISCV, activates Python venv
source ~/cvw/setup.sh
```

## Common Commands

```bash
# Lint RTL with Verilator (fast syntax/logic check, no simulation)
make lint

# Compile RTL + testbench for QuestaSim
make build

# Run basic instruction sanity tests
make bringup_test

# Run full RISC-V architecture compliance suite (~200 tests)
make test

# Run CoreMark benchmark
make coremark

# Synthesize with Design Compiler (default: sky130)
make synth

# Compute final score (requires both synth and coremark results)
make score

# Run a specific ELF file through simulation
make run ELFS="path/to/test.elf"

# Run simulation with Questa GUI for debugging
make run ELFS="path/to/test.elf" GUI=1

# Run against SAIL reference model instead of processor
make run ELFS="path/to/test.elf" SAIL=1

# Clean targets
make clean          # Remove build artifacts
make clean-act4     # Remove arch test artifacts
make clean-coremark # Remove coremark artifacts
make clean-synth    # Remove synthesis artifacts
make clean-all      # Remove everything
```

## Key Makefile Configuration Variables

All are overridable on the command line (e.g., `make build XLEN=64`):

| Variable | Default | Purpose |
|----------|---------|---------|
| `XLEN` | `32` | Data width (32 or 64) |
| `PROCESSOR_DIR` | `RISC-V-Pipelined-Processor/src` | Directory containing all processor RTL |
| `INC_DIR` | `RISC-V-Pipelined-Processor/incdir/` | Include directory for parameters |
| `PROCESSOR_TOP` | `testingCore` | Top-level module name of the processor |
| `PROCESSOR_CONFIG` | `sadhvi/sample_processor/config` | Config dir (linker script, SAIL config, test config) |
| `ARCH` | `rv32i_zicsr` | ISA string for compiling test/benchmark programs |
| `SYNTH_TECH` | `sky130` | Synthesis technology library (`sky130` or `tsmc28`) |
| `SYNTH_TOP` | `synth_top` | Top module for synthesis |

## Architecture

### Processor Interface Contract

Every student processor must expose this exact port interface (see `tb/testbench.sv` and `synth/synth_top.sv`):

```systemverilog
module <PROCESSOR_TOP> (
    input  logic              clk,
    input  logic              reset,
    output logic [XLEN-1:0]   PC,           // instruction fetch address
    input  logic [31:0]       Instr,        // fetched instruction
    output logic [XLEN-1:0]   IEUAdr,       // data memory address
    input  logic [XLEN-1:0]   ReadData,     // data memory read
    output logic [XLEN-1:0]   WriteData,    // data memory write
    output logic              MemEn,        // data memory enable
    output logic              WriteEn,      // data memory write enable
    output logic [XLEN/8-1:0] WriteByteEn   // byte lane enables
);
```

### Testbench (`tb/`)

- **`testbench.sv`** — Instantiates separate instruction and data RAMs (`ram1p1rwb`), the DUT, and handles HTIF semihosting (test pass/fail signaling, character output). Memory is loaded from `.memfile` generated by `elf2hex`.
- **`ram1p1rwb.sv`** — Parameterized single-port RAM with byte-enable writes. Loads memfiles via `$value$plusargs`.
- Memory base address: `0x8000_0000`. MTIME counter at `0x0200_bff8`.
- HTIF/TOHOST protocol: writing `0x1` signals test pass; non-zero even value signals failure code; `0x01010000_000000xx` prints character.

### Synthesis Wrapper (`synth/synth_top.sv`)

Wraps the processor with clean I/O ports (no memory instantiation) for Design Compiler. The `PROCESSORTOP` macro selects the student's top module.

### Test Flows

1. **Bringup** (`tests/bringup/`) — Minimal assembly tests for individual instructions (add, sub, and, or)
2. **Act4** (`tests/act4/`) — RISC-V Architecture Tests populated from `$WALLY/addins/riscv-arch-test-cvw`. Tests RV32I + Zicntr + Zihpm + Zicsr + Zmmul extensions.
3. **C tests** (`tests/C/`) — C programs compiled with RISC-V toolchain (e.g., HelloWorld)
4. **CoreMark** (`coremark/`) — Industry benchmark; results feed into the scoring formula

### Scoring (`bin/score.py`)

Reads synthesis QoR report (`synth/work/synth_top-*/reports/qor.rep`) and CoreMark simulation log (`coremark/work/coremark.bare.riscv.elf.sim.log`). Output goes to `score.log`.

### Available Processor Implementations

- **`RISC-V-Pipelined-Processor/`** — 5-stage pipelined RV32I with hazard unit (currently selected as `PROCESSOR_DIR`)
- **`sample_processor/`** — Simple single-cycle processor template
- **`sadhvi/sample_processor/`** — Another student's enhanced implementation (CSR, multiply/divide)

Switch processors by changing `PROCESSOR_DIR`, `INC_DIR`, and `PROCESSOR_TOP` in the Makefile or on the command line.
